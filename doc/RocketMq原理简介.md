# RocketMq原理简介

#### QA消息中间件需要解决哪些问题 

1. **消息队列的优先级**

   >由于 RocketMQ 所有消息都是持久化的，所以如果按照优先级来排序，开销会非常大，因此 **RocketMQ 没有特意支持消息优先级**，但是可以通过变通的方式实现类似功能，即单独配置一个优先级高的队列，和一个普通优先级 的队列， 将不同优先级发送到不同队列即可。 
   >
   >对于优先级问题，可以归纳为 2 类 
   >
   >​	1) 只要达到优先级目的即可，不是严格意义上的优先级，通常将优先级划分为高、中、低，或者再多几个级 别。每个优先级可以用不同的 topic 表示，发消息时，指定不同的 topic 来表示优先级，这种方式可以解决 绝大部分的优先级问题，但是对业务的优先级精确性做了妥协。 
   >
   >​	2) 严格的优先级，优先级用整数表示，例如 0 ~ 65535，这种优先级问题一般使用不同 topic 解决就非常不合适。如果要让 MQ 解决此问题，会对 MQ 的性能造成非常大的影响。这里要确保一点，业务上是否确实需 要这种严格的优先级，如果将优先级压缩成几个，对业务的影响有多大？ 

2. **影响消息可靠性** 

   >(1). Broker 正常关闭 (2). Broker 异常 Crash (3). OS Crash (4). 机器掉电，但是能立即恢复供电情况。 (5). 机器无法开机（可能是 cpu、主板、内存等关键设备损坏） (6). 磁盘设备损坏。 
   >
   >(1)、(2)、(3)、(4)四种情况都属于硬件资源可立即恢复情况，RocketMQ 在这四种情况下能保证消息不丢，或者丢失少量数据（依赖刷盘方式是同步还是异步）。
   >
   > (5)、(6)属于单点故障，且无法恢复，一旦发生，在此单点上的消息全部丢失。RocketMQ 在这两种情况下，通过异步复制，可保证 99%的消息不丢，但是仍然会有极少量的消息可能丢失。**通过同步双写技术可以完全避免单点， 同步双写势必会影响性能，适合对消息可靠性要求极高的场合，例如与 Money 相关的应用。** 

3. **Exactly Only Once** 

   >(1). 发送消息阶段，不允许发送重复的消息。 
   >
   >(2). 消费消息阶段，不允许消费重复的消息。
   >
   > 只有以上两个条件都满足情况下，才能认为消息是“Exactly Only Once”，而要实现以上两点，在分布式系统环境下，不可避免要产生巨大的开销。所以 **RocketMQ 为了追求高性能，并不保证此特性，要求在业务上进行去重， 也就是说消费消息要做到幂等性**。RocketMQ 虽然不能严格保证不重复，但是正常情况下很少会出现重复发送、消费情况，只有网络异常，Consumer 启停等异常情况下会出现消息重复。 此问题的本质原因是网络调用存在不确定性，即既不成功也不失败的第三种状态，所以才产生了消息重复性问题

   